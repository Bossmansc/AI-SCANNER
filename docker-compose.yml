# Redis Development Stack
# Purpose: Local Redis service configuration for development and testing
# Version: 2.4
# Networks: Isolated 'redis-net' for secure service communication
# Volumes: Persistent data storage for Redis instances
# Healthchecks: Automated service health verification
# Ports: Standard Redis ports with localhost binding for security

version: '2.4'

# Define custom networks for service isolation
networks:
  redis-net:
    driver: bridge
    # Enable IPv6 for modern network testing
    enable_ipv6: true
    # Internal network for enhanced security
    internal: false
    ipam:
      driver: default
      config:
        - subnet: "172.22.0.0/16"
          gateway: "172.22.0.1"
        - subnet: "2001:db8:1::/64"
          gateway: "2001:db8:1::1"

# Define persistent volumes for data storage
volumes:
  redis-data:
    driver: local
    # Labels for volume management
    labels:
      - "com.redis-stack.description=Primary Redis data volume"
      - "com.redis-stack.backup=true"
  redis-config:
    driver: local
    labels:
      - "com.redis-stack.description=Redis configuration volume"
  redis-insight-data:
    driver: local
    labels:
      - "com.redis-stack.description=Redis Insight UI data volume"

# Service definitions
services:
  # Primary Redis instance with persistence
  redis:
    image: redis:7.2-alpine
    container_name: redis-primary
    hostname: redis-primary
    restart: unless-stopped
    # Security: Run as non-root user
    user: "1001:1001"
    # Resource limits for development environment
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    # Command with optimized configuration
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-devpassword123}
      --bind 0.0.0.0
      --port 6379
    # Environment variables
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword123}
      - REDIS_PORT=6379
      - TZ=UTC
    # Health check configuration
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-devpassword123}", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Port mapping (localhost binding for security)
    ports:
      - "127.0.0.1:6379:6379"
    # Volume mounts for persistence
    volumes:
      - redis-data:/data
      - redis-config:/usr/local/etc/redis
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/healthcheck.sh:/healthcheck.sh:ro
    # Network configuration
    networks:
      redis-net:
        ipv4_address: 172.22.0.10
        ipv6_address: 2001:db8:1::10
    # Security options
    security_opt:
      - no-new-privileges:true
    # Read-only root filesystem
    read_only: true
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-primary"
    # Labels for container management
    labels:
      - "com.redis-stack.role=primary"
      - "com.redis-stack.environment=development"
      - "com.redis-stack.maintenance.window=Sun:02:00-04:00"

  # Redis replica for read scalability
  redis-replica:
    image: redis:7.2-alpine
    container_name: redis-replica
    hostname: redis-replica
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    # Replica configuration
    command: >
      redis-server
      --replicaof redis-primary 6379
      --masterauth ${REDIS_PASSWORD:-devpassword123}
      --requirepass ${REDIS_PASSWORD:-devpassword123}
      --appendonly yes
      --appendfsync everysec
      --bind 0.0.0.0
      --port 6380
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword123}
      - REDIS_MASTER_HOST=redis-primary
      - REDIS_MASTER_PORT=6379
      - REDIS_REPLICA_PORT=6380
      - TZ=UTC
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-devpassword123}", "-p", "6380", "--raw", "info", "replication"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 40s
    ports:
      - "127.0.0.1:6380:6380"
    volumes:
      - redis-data:/data:ro
      - ./scripts/replica-setup.sh:/setup.sh:ro
    networks:
      redis-net:
        ipv4_address: 172.22.0.11
        ipv6_address: 2001:db8:1::11
    security_opt:
      - no-new-privileges:true
    read_only: true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-replica"
    labels:
      - "com.redis-stack.role=replica"
      - "com.redis-stack.environment=development"

  # Redis Commander - Web-based management UI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    hostname: redis-commander
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      redis-replica:
        condition: service_started
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M
    environment:
      - REDIS_HOSTS=local:redis-primary:6379,local-replica:redis-replica:6380
      - REDIS_PASSWORD=devpassword123
      - HTTP_USER=${REDIS_COMMANDER_USER:-admin}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD:-admin123}
      - REDIS_PORT=6379
      - REDIS_REPLICA_PORT=6380
      - TZ=UTC
      - HTTP_BASIC_AUTH_PASSWORD_HASH=${REDIS_COMMANDER_HASH:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ports:
      - "127.0.0.1:8081:8081"
    volumes:
      - ./redis-commander.json:/redis-commander/config/local-production.json:ro
    networks:
      redis-net:
        ipv4_address: 172.22.0.12
        ipv6_address: 2001:db8:1::12
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-commander"
    labels:
      - "com.redis-stack.role=management-ui"
      - "com.redis-stack.environment=development"

  # Redis Insight - Official Redis GUI
  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    hostname: redis-insight
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword123}
      - RITRUSTEDORIGINS=http://localhost:8001
      - RIHOST=0.0.0.0
      - RIPORT=8001
      - TZ=UTC
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    ports:
      - "127.0.0.1:8001:8001"
    volumes:
      - redis-insight-data:/db
      - ./redisinsight-config.json:/config.json:ro
    networks:
      redis-net:
        ipv4_address: 172.22.0.13
        ipv6_address: 2001:db8:1::13
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-insight"
    labels:
      - "com.redis-stack.role=insight-ui"
      - "com.redis-stack.environment=development"

  # Redis Exporter for Prometheus metrics
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    hostname: redis-exporter
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      redis-replica:
        condition: service_started
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M
        reservations:
          cpus: '0.1'
          memory: 32M
    command: >
      --redis.addr=redis://redis-primary:6379
      --redis.password=${REDIS_PASSWORD:-devpassword123}
      --redis.addr=redis://redis-replica:6380
      --redis.password=${REDIS_PASSWORD:-devpassword123}
      --web.listen-address=:9121
      --log-format=json
      --debug
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword123}
      - TZ=UTC
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    ports:
      - "127.0.0.1:9121:9121"
    networks:
      redis-net:
        ipv4_address: 172.22.0.14
        ipv6_address: 2001:db8:1::14
    security_opt:
      - no-new-privileges:true
    read_only: true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-exporter"
    labels:
      - "com.redis-stack.role=metrics-exporter"
      - "com.redis-stack.environment=development"

  # Redis CLI utility container
  redis-cli:
    image: redis:7.2-alpine
    container_name: redis-cli-util
    hostname: redis-cli-util
    restart: "no"
    depends_on:
      redis:
        condition: service_healthy
    user: "1001:1001"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 32M
        reservations:
          cpus: '0.1'
          memory: 16M
    stdin_open: true
    tty: true
    command: >
      sh -c "
      echo 'Waiting for Redis to be ready...' &&
      until redis-cli -h redis-primary -p 6379 -a ${REDIS_PASSWORD:-devpassword123} ping | grep -q PONG; do
        sleep 1;
      done &&
      echo 'Redis is ready. Starting CLI...' &&
      redis-cli -h redis-primary -p 6379 -a ${REDIS_PASSWORD:-devpassword123}
      "
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-devpassword123}
      - TZ=UTC
    volumes:
      - ./scripts:/scripts:ro
      - ./data:/data:rw
    networks:
      redis-net:
        ipv4_address: 172.22.0.15
        ipv6_address: 2001:db8:1::15
    security_opt:
      - no-new-privileges:true
    read_only: false
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        tag: "redis-cli"
    labels:
      - "com.redis-stack.role=cli-utility"
      - "com.redis-stack.environment=development"

# Custom configuration sections
x-redis-defaults: &redis-defaults
  restart: unless-stopped
  user: "1001:1001"
  networks:
    - redis-net
  security_opt:
    - no-new-privileges:true
  logging: &default-logging
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s

x-resource-defaults: &resource-defaults
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
      reservations:
        cpus: '0.25'
        memory: 128M

# Service aliases for easier access
x-service-aliases:
  primary: &redis-primary redis://redis-primary:6379
  replica: &redis-replica redis://redis-replica:6380
  commander: &redis-commander http://localhost:8081
  insight: &redis-insight http://localhost:8001
  exporter: &redis-exporter http://localhost:9121

# Environment variable defaults (for .env file generation)
x-env-defaults:
  REDIS_PASSWORD: "devpassword123"
  REDIS_COMMANDER_USER: "admin"
  REDIS_COMMANDER_PASSWORD: "admin123"
  REDIS_COMMANDER_HASH: ""
  REDIS_DATA_DIR: "./data"
  REDIS_CONFIG_DIR: "./config"
  REDIS_SCRIPTS_DIR: "./scripts"

# Volume configuration defaults
x-volume-defaults:
  driver: local
  driver_opts:
    type: none
    o: bind
    device: ${PWD}/data

# Network configuration defaults
x-network-defaults:
  driver: bridge
  attachable: true
  external: false

# Port mapping documentation
x-port-mappings:
  redis-primary: "6379/tcp -> 127.0.0.1:6379"
  redis-replica: "6380/tcp -> 127.0.0.1:6380"
  redis-commander: "8081/tcp -> 127.0.0.1:8081"
  redis-insight: "8001/tcp -> 127.0.0.1:8001"
  redis-exporter: "9121/tcp -> 127.0.0.1:9121"

# Health check endpoints
x-health-endpoints:
  redis-primary: "redis-cli -a $REDIS_PASSWORD ping"
  redis-replica: "redis-cli -a $REDIS_PASSWORD -p 6380 info replication"
  redis-commander: "http://localhost:8081/health"
  redis-insight: "http://localhost:8001/health"
  redis-exporter: "http://localhost:9121/metrics"

# Usage instructions
x-usage:
  start: "docker-compose up -d"
  stop: "docker-compose down"
  restart: "docker-compose restart"
  logs: "docker-compose logs -f"
  status: "docker-compose ps"
  cli: "docker-compose exec redis-cli"
  backup: "docker-compose exec redis-primary redis-cli -a $REDIS_PASSWORD save"
  monitor: "docker-compose exec redis-primary redis-cli -a $REDIS_PASSWORD monitor"
  info: "docker-compose exec redis-primary redis-cli -a $REDIS_PASSWORD info"
  flush: "docker-compose exec redis-primary redis-cli -a $REDIS_PASSWORD flushall"
  stats: "docker-compose exec redis-primary redis-cli -a $REDIS_PASSWORD info stats"

# Security notes
x-security-notes:
  - "All services run as non-root user (UID 1001)"
  - "Root filesystem is read-only where possible"
  - "No new privileges can be gained"
  -